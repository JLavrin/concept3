name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      #BUMP VERSIONS
      - name: Bump version and create tag
        id: version
        run: |
          # Get the current version from the latest tag
          VERSION=$(git describe --abbrev=0)
          
          # Split the version into parts (e.g. "v1.2.3" => "1" "2" "3")
          MAJOR=$(echo $VERSION | cut -d '.' -f 1 | sed 's/v//')
          MINOR=$(echo $VERSION | cut -d '.' -f 2)
          PATCH=$(echo $VERSION | cut -d '.' -f 3)
          
          # Increment the appropriate version part based on the bump type
          case "${{ github.event.inputs.bump }}" in
              MAJOR)
                  MAJOR=$((MAJOR+1))
                  MINOR=0
                  PATCH=0
                  ;;
              MINOR)
                  MINOR=$((MINOR+1))
                  PATCH=0
                  ;;
              PATCH)
                  PATCH=$((PATCH+1))
                  ;;
          esac
          
          # Create the new version tag and push it to the repository
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          git tag $NEW_VERSION
          git push origin $NEW_VERSION
          echo "::set-output name=version_tag::$NEW_VERSION"

      # DEPLOY TO HEROKU SERVICES
      - name: Deploy to Heroku
        id: deploy_to_heroku
        uses: akhileshns/heroku-deploy@v3.12.13
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: ${{secrets.HEROKU_APP_NAME}}
          heroku_email: ${{secrets.HEROKU_APP_EMAIL}}
      - run: echo "Deployed Successfully"
